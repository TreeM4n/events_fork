mem_ancestors_grudge_give_random_archeotech = {
	if = {
		limit = {
			host_has_dlc = "Ancient Relics Story Pack"
		}
		add_random_research_option = {
			category = archaeostudies
			#area = RANDOM
			#tier = <int>
			add_progress = 0.5
			ignore_prereqs = no
			ignore_rare = no
			only_rare = no
			ignore_insight = yes
			fail_effects = {
				add_resource = {
					minor_artifacts = 100
				}
				add_monthly_resource_mult = {
					resource = physics_research
					value = 1
				}
				add_monthly_resource_mult = {
					resource = society_research
					value = 1
				}
				add_monthly_resource_mult = {
					resource = engineering_research
					value = 1
				}
			}
		}
	}
	else = {
		add_random_research_option = {
			category = materials
			#area = RANDOM
			#tier = <int>
			add_progress = 0.5
			ignore_prereqs = no
			ignore_rare = no
			only_rare = no
			ignore_insight = yes
			fail_effects = {
				add_monthly_resource_mult = {
					resource = engineering_research
					value = 3
				}
			}
		}
	}
}

mem_ancestors_grudge_remove_all_relics = {
	if = {
		limit = {
			has_relic = r_mem_ancestors_grudge_pauldron
		}
		remove_relic = r_mem_ancestors_grudge_pauldron
	}
	if = {
		limit = {
			has_relic = r_mem_ancestors_grudge_ring
		}
		remove_relic = r_mem_ancestors_grudge_ring
	}
	if = {
		limit = {
			has_relic = r_mem_ancestors_grudge_sword
		}
		remove_relic = r_mem_ancestors_grudge_sword
	}
}

mem_ancestors_grudge_trait_effect = {
	add_trait = leader_trait_legendary_mem_ancestors_grudge_relicowner
	hidden_effect = {
		set_variable = {
			which = mem_ancestors_grudge_smithing_purity_rolled
			value = owner.mem_ancestors_grudge_smithing_purity_rolled
		}
		set_variable = {
			which = mem_ancestors_grudge_smithing_quality_rolled
			value = owner.mem_ancestors_grudge_smithing_quality_rolled
		}
		if = {
			limit = {
				owner = {
					has_country_flag = mem_ancestors_grudge_relic_flag1
				}
			}
			set_leader_flag = mem_ancestors_grudge_relic_flag1
		}
		if = {
			limit = {
				owner = {
					has_country_flag = mem_ancestors_grudge_relic_flag2
				}
			}
			set_leader_flag = mem_ancestors_grudge_relic_flag2
		}
		if = {
			limit = {
				owner = {
					has_country_flag = mem_ancestors_grudge_relic_flag3
				}
			}
			set_leader_flag = mem_ancestors_grudge_relic_flag3
		}
		if = {
			limit = {
				owner = {
					has_country_flag = mem_ancestors_grudge_relic_flag4
				}
			}
			set_leader_flag = mem_ancestors_grudge_relic_flag4
		}
		if = {
			limit = {
				owner = {
					has_country_flag = mem_ancestors_grudge_relic_flag5
				}
			}
			set_leader_flag = mem_ancestors_grudge_relic_flag5
		}
		if = {
			limit = {
				owner = {
					has_country_flag = mem_ancestors_grudge_relic_flag6
				}
			}
			set_leader_flag = mem_ancestors_grudge_relic_flag6
		}
		if = {
			limit = {
				owner = {
					has_country_flag = mem_ancestors_grudge_relic_flag7
				}
			}
			set_leader_flag = mem_ancestors_grudge_relic_flag7
		}
		if = {
			limit = {
				owner = {
					has_country_flag = mem_ancestors_grudge_relic_flag8
				}
			}
			set_leader_flag = mem_ancestors_grudge_relic_flag8
		}
	}
}

# new purities
mem_ancestors_grudge_roll_for_relic_purity = {
	owner = {
		clear_variable = mem_ancestors_grudge_smithing_purity_rolled
		set_variable = {
			which = mem_ancestors_grudge_smithing_chance_purity
			value = owner.modifier:mem_ancestors_grudge_rune_power_produces_mult
		}
		change_variable = {
			which = mem_ancestors_grudge_smithing_chance_purity
			value = 1
		}
		random_list = {
			1 = {
				modifier = {
					mult = owner.mem_ancestors_grudge_smithing_quality_rolled
					NOT = {
						check_variable_arithmetic = {
							which = owner.mem_ancestors_grudge_smithing_quality_rolled
							value < 0
						}
					}
				}
				set_variable = {
					which = mem_ancestors_grudge_smithing_purity_rolled
					value = 0.5
				}
			}
			2 = {
				modifier = {
					mult = owner.mem_ancestors_grudge_smithing_quality_rolled
					NOT = {
						check_variable_arithmetic = {
							which = owner.mem_ancestors_grudge_smithing_quality_rolled
							value < 0
						}
					}
				}
				set_variable = {
					which = mem_ancestors_grudge_smithing_purity_rolled
					value = 0.75
				}
			}
			20 = {
				# modifier = {
				# 	mult = owner.mem_ancestors_grudge_smithing_chance_purity
				# }
				set_variable = {
					which = mem_ancestors_grudge_smithing_purity_rolled
					value = 1
				}
			}
			20 = {
				modifier = {
					mult = owner.mem_ancestors_grudge_smithing_chance_purity
				}
				set_variable = {
					which = mem_ancestors_grudge_smithing_purity_rolled
					value = 1.25
				}
			}
			10 = {
				modifier = {
					mult = owner.mem_ancestors_grudge_smithing_chance_purity
				}
				set_variable = {
					which = mem_ancestors_grudge_smithing_purity_rolled
					value = 1.5
				}
			}
		}
		# this is to produce more random looking variables
		random_list = {
			1 = {
				multiply_variable = {
					which = mem_ancestors_grudge_smithing_purity_rolled
					value = 1.07
				}
			}
			1 = {
				multiply_variable = {
					which = mem_ancestors_grudge_smithing_purity_rolled
					value = 1.13
				}
			}
			1 = {
				multiply_variable = {
					which = mem_ancestors_grudge_smithing_purity_rolled
					value = 0.96
				}
			}
			1 = {
				multiply_variable = {
					which = mem_ancestors_grudge_smithing_purity_rolled
					value = 0.83
				}
			}
			1 = {
				multiply_variable = {
					which = mem_ancestors_grudge_smithing_purity_rolled
					value = 1.02
				}
			}
		}
		clear_variable = mem_ancestors_grudge_smithing_chance_purity
	}
}

# new qualities
# countryflag name = loc name
# mundane = mundane 
# common = decent
# rare = excellent
# epic = superior
# exceptional = exceptional
# masterful = masterful
# legendary = legendary
mem_ancestors_grudge_roll_for_relic_rarity = {
	owner = {
		# clear old variable
		clear_variable = mem_ancestors_grudge_smithing_quality_rolled
		# add between 1 and 7
		set_variable = {
			which = mem_ancestors_grudge_smithing_chance
			value = owner.value:mem_ancestors_grudge_situation_rarity
		}
		# delete before the comma and let the fraction remain
		subtract_variable = {
			which = mem_ancestors_grudge_smithing_chance
			value = owner.value:mem_ancestors_grudge_situation_rarity_floored
		}
		# negative roll
		set_variable = {
			which = mem_ancestors_grudge_smithing_chance_negative
			value = 1
		}
		subtract_variable = {
			which = mem_ancestors_grudge_smithing_chance_negative
			value = mem_ancestors_grudge_smithing_chance
		}
		# multiply fraction to represent percentage, not sure if random_list works with fractions
		multiply_variable = {
			which = mem_ancestors_grudge_smithing_chance
			value = 100
		}
		multiply_variable = {
			which = mem_ancestors_grudge_smithing_chance_negative
			value = 100
		}
		# set variable for expacted value
		set_variable = {
			which = mem_ancestors_grudge_smithing_quality
			value = owner.value:mem_ancestors_grudge_situation_rarity
		}
		# increase by roll chance events
		if = {
			limit = {
				is_variable_set = mem_ancestors_grudge_rarity_increase
			}
			change_variable = {
				which = mem_ancestors_grudge_smithing_quality
				value = mem_ancestors_grudge_rarity_increase
			}
		}
		# now lets start rolling 
		# numbers refer to the actual rarity
		# if you change something here, you also need to change the Tooltips!
		if = {
			limit = {
				check_variable_arithmetic = {
					which = owner.mem_ancestors_grudge_smithing_quality
					value < 0
				}
			}
			inline_script = {
				script = mem_ancestors_grudge/roll_rarity
				FLAG1 = 0
				FLAG2 = 0
				FLAG3 = 1
				FLAG4 = 1
				FLAG5 = 1
			}
		}
		else_if = {
			limit = {
				check_variable_arithmetic = {
					which = owner.mem_ancestors_grudge_smithing_quality
					value < 1
				}
			}
			inline_script = {
				script = mem_ancestors_grudge/roll_rarity
				FLAG1 = 0
				FLAG2 = 1
				FLAG3 = 1
				FLAG4 = 2
				FLAG5 = 3
			}
		}
		else_if = {
			limit = {
				check_variable_arithmetic = {
					which = owner.mem_ancestors_grudge_smithing_quality
					value < 2
				}
			}
			inline_script = {
				script = mem_ancestors_grudge/roll_rarity
				FLAG1 = 1
				FLAG2 = 1
				FLAG3 = 2
				FLAG4 = 3
				FLAG5 = 4
			}
		}
		else_if = {
			limit = {
				check_variable_arithmetic = {
					which = owner.mem_ancestors_grudge_smithing_quality
					value < 3
				}
			}
			inline_script = {
				script = mem_ancestors_grudge/roll_rarity
				FLAG1 = 1
				FLAG2 = 2
				FLAG3 = 3
				FLAG4 = 4
				FLAG5 = 4
			}
		}
		else_if = {
			limit = {
				check_variable_arithmetic = {
					which = owner.mem_ancestors_grudge_smithing_quality
					value < 4
				}
			}
			inline_script = {
				script = mem_ancestors_grudge/roll_rarity
				FLAG1 = 2
				FLAG2 = 3
				FLAG3 = 3
				FLAG4 = 4
				FLAG5 = 4
			}
		}
		else_if = {
			limit = {
				check_variable_arithmetic = {
					which = owner.mem_ancestors_grudge_smithing_quality
					value < 5
				}
			}
			inline_script = {
				script = mem_ancestors_grudge/roll_rarity
				FLAG1 = 3
				FLAG2 = 3
				FLAG3 = 4
				FLAG4 = 4
				FLAG5 = 5
			}
		}
		else_if = {
			limit = {
				check_variable_arithmetic = {
					which = owner.mem_ancestors_grudge_smithing_quality
					value < 6
				}
			}
			inline_script = {
				script = mem_ancestors_grudge/roll_rarity
				FLAG1 = 3
				FLAG2 = 4
				FLAG3 = 4
				FLAG4 = 5
				FLAG5 = 5
			}
		}
		else_if = {
			limit = {
				OR = {
					check_variable_arithmetic = {
						which = owner.mem_ancestors_grudge_smithing_quality
						value <= 7
					}
					check_variable_arithmetic = {
						which = owner.mem_ancestors_grudge_smithing_quality
						value > 7
					}
				}
			}
			inline_script = {
				script = mem_ancestors_grudge/roll_rarity
				FLAG1 = 4
				FLAG2 = 5
				FLAG3 = 5
				FLAG4 = 5
				FLAG5 = 6
			}
		}
		while = {
			count = owner.mem_ancestors_grudge_smithing_quality_rolled
			owner = {
				mem_ancestors_grudge_add_relic_modifier = yes
			}
		}
		clear_variable = mem_ancestors_grudge_smithing_quality
		clear_variable = mem_ancestors_grudge_rarity_increase
		clear_variable = mem_ancestors_grudge_smithing_chance_negative
		clear_variable = mem_ancestors_grudge_smithing_chance
	}
}

mem_ancestors_grudge_increase_jobs_onforge_planet = {
	custom_tooltip = mem_ancestors_grudge_increase_jobs_onforge_planet_tt
	hidden_effect = {
		change_variable = {
			which = mem_ancestors_grudge_relicforge_extrajobs
			value = 1
		}
	}
}

mem_ancestors_grudge_increase_relic_roll_quality = {
	custom_tooltip = mem_ancestors_grudge_increase_relic_roll_quality_tt
	hidden_effect = {
		change_variable = {
			which = mem_ancestors_grudge_rarity_increase
			value = 1
		}
	}
}

mem_ancestors_grudge_decrease_relic_roll_quality = {
	custom_tooltip = mem_ancestors_grudge_decrease_relic_roll_quality_tt
	hidden_effect = {
		change_variable = {
			which = mem_ancestors_grudge_rarity_increase
			value = -1
		}
	}
}

mem_ancestors_grudge_add_relic_modifier = {
	random_list = {
		1 = {
			set_country_flag = mem_ancestors_grudge_relic_flag1
			modifier = {
				has_country_flag = mem_ancestors_grudge_relic_flag1
				factor = 0
			}
		}
		1 = {
			set_country_flag = mem_ancestors_grudge_relic_flag2
			modifier = {
				has_country_flag = mem_ancestors_grudge_relic_flag2
				factor = 0
			}
		}
		1 = {
			set_country_flag = mem_ancestors_grudge_relic_flag3
			modifier = {
				has_country_flag = mem_ancestors_grudge_relic_flag3
				factor = 0
			}
		}
		1 = {
			set_country_flag = mem_ancestors_grudge_relic_flag4
			modifier = {
				has_country_flag = mem_ancestors_grudge_relic_flag4
				factor = 0
			}
		}
		1 = {
			set_country_flag = mem_ancestors_grudge_relic_flag5
			modifier = {
				has_country_flag = mem_ancestors_grudge_relic_flag5
				factor = 0
			}
		}
		1 = {
			set_country_flag = mem_ancestors_grudge_relic_flag6
			modifier = {
				has_country_flag = mem_ancestors_grudge_relic_flag6
				factor = 0
			}
		}
		1 = {
			set_country_flag = mem_ancestors_grudge_relic_flag7
			modifier = {
				has_country_flag = mem_ancestors_grudge_relic_flag7
				factor = 0
			}
		}
		1 = {
			set_country_flag = mem_ancestors_grudge_relic_flag8
			modifier = {
				has_country_flag = mem_ancestors_grudge_relic_flag8
				factor = 0
			}
		}
	}
}
